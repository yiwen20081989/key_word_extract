惊魂百万亿次：曙光5000A冲击Top500纪实

　　本报记者 马文方 刘洪宇 那罡
　　“聂总让你来一趟。”
　　“什么事呀，非要我去一趟？”
　　“聂总点名让你来！” 
　　“好吧，我这就过来。” 
　　2008年10月7日下午，在曙光5000A测试现场干了一个通宵的微软中国研发集团战略合作部数据中心经理李铭才回家休息了不到3个小时，就又被叫回了中科院计算所地下二层。这里是计算所的车库，一个月前才刚刚被临时改装成测试现场。
　　在多种噪声交织的测试现场，曙光公司副总裁聂华大声对李铭说：“计算所9日就要停电改造供电系统，如果你们在这之前结果还没有一个显著提升，我就只好换成Linux了。”
　　换Linux！这意味着Windows将在曙光5000A的系统性能测试中出局，李铭和他的同事们大半年的努力和连日来24小时倒班的付出都将付诸东流。
　　冒险搏一把
　　2008年1月底，微软负责高性能计算机(HPC)系统销售的李?得知，计算所和曙光公司作为研制单位在“十一五”863计划重大项目“高效能计算机及网格服务环境”上中标，联合承接了该项目两台每秒百万亿次浮点运算高效能计算机中1台的研制任务。这就是人们现在看到的曙光5000A。 
　　李?把这件事告诉了李铭和微软中国平台战略总监李科研。三个人商量后，觉得可以尝试一下在Windows平台上测试曙光5000A的性能。话虽这么说，但三人的心里一点底儿都没有。
　　从技术上看，微软在2005年11月的超级计算大会上才发布了用于高性能计算的Windows Computer Cluster Server 2003(WCCS 2003)的测试版，开始向高性能计算领域进军。后来这个操作系统的下一代版本更名为Windows HPC Sever 2008(WHS 2008)。即使到了2008年1月，WHS 2008也还处于测试阶段，并没有正式发布。即使是这个最新版本，所标称支持的高性能计算机规模也只有256个节点，而曙光5000A最初设计规模就达到1300个节点。
　　尽管李铭知道微软总部那边正在做的最大项目是美国伊利诺伊大学国家超级计算中心(NCSA)的机器，有1074个节点，但其规模也要比曙光5000A的1300个节点小不少。
　　说到人手，微软在中国做HPC项目的人真可谓是屈指可数，加上上海那边研发团队的十几个人，总数也不过20人。曙光5000A原计划2008年6月冲击全球500强，这与NCSA的项目在时间上重合。到那时，总部的人手将都在为NCSA忙活，分身乏术。
　　但是，能在曙光5000A这样规模的计算平台上做事，对任何做HPC的人来说都是梦寐以求的事情。这对“三李”当然也不例外。尽管“本钱”差得很远，但“三李”觉得还是值得冒险一搏，大家商定先悄悄地干，即便失败了也不至于闹得满城风雨。
　　由于之前微软和曙光在个人HPC上签署过战略合作协议，双方都很熟悉，于是，李铭找到聂华。尽管李铭心里打着在Windows平台上测试曙光5000A性能的算盘，但口中却对聂华说，希望在曙光5000A平台上测试一下WHS 2008测试版。
　　聂华当然听得出李铭的弦外之音，并爽快地答应让李铭他们先试一试。如果测试结果令人满意，可以先用Windows测，否则还是要用Linux。
　　至于说为什么同意让Windows先试试，聂华心里也有自己的打算。
　　“三李”终于如愿以偿，可以在曙光5000A上试一试。但后来在测试过程中出现的风险和压力，却是他们始料未及的。 
　　迎头一记闷棍
　　聂华答应可以试试Windows的时候，曙光5000A的硬件还没有做出来。毕竟曙光5000A太大了，加之整个系统应用了很多新技术，必须通过多种方式进行验证，以消除系统的不确定因素，而节点样机则是验证曙光5000A计算节点和管理节点设计的重要步骤。
　　曙光5000A用了近万片“巴塞罗那”CPU，这是AMD当时最新的4核服务器CPU。每4个CPU构成一个4路刀片服务器作为计算节点，每16个CPU构成一个用于浮点计算的胖节点，最终，由1920个节点构成曙光5000A这个庞大的计算系统。
　　衡量这些庞然大物性能的权威排名是Top500，它是由德国曼海姆大学在1993创立的，每年6月和11月都会发布全球500台最快计算机系统的最新排名。
　　Top500主要依据的是Linpack运行的结果。这个上世纪70年代开发的基准测试程序，实际上是通过对一元N次线性代数方程组的求解，来测试高性能计算机的浮点计算性能。只要给出N值，所需的运算次数也就确定了，这样，只要除以运算所用的时间，便可得到高性能计算机的浮点运算速度。在高性能计算领域，通常用每秒万亿次浮点计算作为基准单位，人们更愿意用T来简称。
　　就像木桶原理所说的，水装得多少不仅与桶的大小相关，而且取决于木桶最短的一块板那样，Linpack测试不仅要求系统中所有节点的计算和通信性能足够强，更重要的是不能有弱点。Linpack采用的是并行的迭代计算，只有等到最后一个节点计算结束后，才能进入下一次迭代。从这个意义上讲，Linpack测试是很残酷的，它是对系统整体性能的测试，只要系统中有一个节点计算或者通信性能不好，就会拖累整个系统性能。由于做Linpack时硬件没有冗余，有时候，测试程序已经跑了好几个小时，可能因为一根内存条出现故障，都会导致整个测试前功尽弃。
　　一个多月后，4台节点样机出来了，两台运行Linux，另两台则交给微软运行Windows。微软中国研究中心资深HPC顾问叶向宇和同事敖翔兴冲冲地跑到曙光公司体验中心，把Linpack测试程序装到机器上。但测试程序运行完成后，结果犹如给了他们一记闷棍——效率只有46%！而Linux不用优化就可以轻松达到75%。
　　对首次测试结果成绩可能不太理想，尽管李铭他们心里有所准备，但成绩相差这么多，还是大大出乎他们的预料。
　　此时，聂华心里凉了半截，他的压力可能比李铭他们还要大，毕竟之前曙光高性能计算机的Linpack测试都是在Linux上进行的，为什么要冒险尝试Windows呢？


